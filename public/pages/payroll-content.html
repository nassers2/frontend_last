<!-- ğŸ’° Payroll Management Page - v7.0 with Advance Deduction -->
<style>
  .payroll-container { padding: 0; margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: #f1f5f9; }
  /* ===== Shell ===== */
  .card { background: #fff; padding: 24px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  .accent-violet { border-right: 4px solid #8b5cf6; }
  .accent-amber { border-right: 4px solid #f59e0b; }

  /* ===== Header ===== */
  .header-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
  .icon-box { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); }
  .title { color: #1e293b; margin: 0; font-size: 24px; }
  .subtitle { color: #64748b; font-size: 14px; margin: 6px 0 0 0; }

  /* ===== Controls ===== */
  .grid { display: grid; gap: 16px; }
  .grid.auto-200 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
  .grid.auto-180 { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
  .grid.auto-250 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); align-items: end; }
  label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px; }
  input[type="number"], input[type="date"], select { width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
  .btn { padding: 10px 16px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; border: none; }
  .btn-outline { background: #fff; border: 1px solid #e2e8f0; color: #334155; }
  .btn-primary { background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: #fff; }
  .btn-warn    { background: #f59e0b; color: #fff; }
  .btn-green   { background: #10b981; color: #fff; }
  .btn-blue    { background: #3b82f6; color: #fff; }
  .btn-indigo  { background: #6366f1; color: #fff; }

  /* ===== Table ===== */
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead { background: #f8fafc; position: sticky; top: 0; z-index: 10; }
  th { padding: 12px 10px; text-align: center; font-weight: 600; color: #475569; font-size: 12px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
  th:first-child { text-align: right; }
  td { padding: 10px 10px; border-bottom: 1px solid #f1f5f9; color: #334155; text-align: center; vertical-align: middle; }
  td:first-child { text-align: right; }
  tbody tr:hover { background: #fafbfc; transition: all 0.2s; }

  .driver-info { display: flex; align-items: center; gap: 10px; }
  .driver-avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 13px; flex-shrink: 0; }
  .driver-details { display: flex; flex-direction: column; justify-content: center; }
  .driver-name { font-weight: 600; font-size: 13px; line-height: 1.3; margin-bottom: 2px; }
  .driver-phone { font-size: 11px; color: #64748b; line-height: 1.3; }

  .status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .status-draft { background: #e0e7ff; color: #3730a3; }
  .status-approved { background: #d1fae5; color: #065f46; }
  .status-paid { background: #dbeafe; color: #1e40af; }

  .metric-value { font-weight: 600; font-size: 12px; padding: 4px 8px; border-radius: 6px; background: #f1f5f9; color: #475569; display: inline-block; min-width: 60px; text-align: center; }

  .loading-spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .notice { background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px; padding: 12px; margin-bottom: 16px; color: #92400e; font-size: 12px; }
  
  .formula-box { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-top: 12px; font-size: 12px; color: #475569; line-height: 1.6; }
</style>

<div class="payroll-container">

  <!-- Header -->
  <div class="card accent-violet" style="margin-bottom: 24px;">
    <div class="header-row">
      <div style="display:flex; align-items:center; gap:16px;">
        <div class="icon-box">ğŸ’°</div>
        <div>
          <h2 class="title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨</h2>
          <p class="subtitle">Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Card -->
  <div class="card accent-amber" style="margin-bottom: 24px;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
      <h3 style="font-size:16px; font-weight:600; color:#1e293b; display:flex; align-items:center; gap:8px;">
        <span>âš™ï¸</span><span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨</span>
      </h3>
      <button id="toggle-settings-btn" class="btn btn-outline" onclick="toggleSettings()">
        <span id="toggle-icon">â–¼</span> <span id="toggle-text">Ø¥Ø¸Ù‡Ø§Ø±</span>
      </button>
    </div>

    <div id="settings-container" style="display:none;">
      <!-- Calculation Type Selector -->
      <div style="margin-bottom:20px;">
        <label>ğŸ¯ Ù†Ø¸Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨</label>
        <select id="calculation-type" onchange="onCalculationTypeChange()" style="font-size: 15px;">
          <option value="target_orders">ØªØ§Ø±Ø¬Øª Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</option>
          <option value="freelancer">ÙØ±ÙŠ Ù„Ø§Ù†Ø³Ø±</option>
        </select>
      </div>

      <!-- Common Settings -->
      <div style="margin-bottom:20px;">
        <label>ğŸ’° Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø±.Ø³)</label>
        <input type="number" id="base-salary" step="0.01" placeholder="0.00" />
        <small style="color:#64748b; font-size:11px; display:block; margin-top:4px;">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø«Ø§Ø¨Øª Ø§Ù„Ù…Ø¶Ø§Ù Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©</small>
      </div>

      <!-- Target Orders Settings (Default visible) -->
      <div id="target-orders-group">
        <div class="grid auto-200" style="margin-bottom:16px;">
          <div>
            <label>ğŸ¯ ØªØ§Ø±Ø¬Øª Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</label>
            <input type="number" id="target-orders" placeholder="450" />
          </div>
          <div>
            <label>ğŸ Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ØªØ§Ø±Ø¬Øª (Ø±.Ø³)</label>
            <input type="number" id="target-bonus" step="0.01" placeholder="0.00" />
          </div>
          <div>
            <label>ğŸ“¦ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø±.Ø³)</label>
            <input type="number" id="order-value-default" step="0.01" value="4.4" />
          </div>
          <div>
            <label>ğŸš€ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ§Ø±Ø¬Øª (Ø±.Ø³)</label>
            <input type="number" id="order-value-after-target" step="0.01" value="4.4" />
          </div>
        </div>
        
        <div class="formula-box">
          <strong>ğŸ“ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©:</strong><br>
          Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª + Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ + Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ØªØ§Ø±Ø¬Øª + (Ø§Ù„Ø¥ÙƒØ±Ø§Ù…ÙŠØ§Øª + Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª + Ø§Ù„Ø¯Ø§Ø¦Ù†) - ((Ø§Ù„Ù†Ù‚Ø¯ - Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø³ØªÙ„Ù…) + Ø§Ù„ØºØ±Ø§Ù…Ø§Øª + Ø§Ù„Ù…Ø¯ÙŠÙ†) - Ø®ØµÙ… Ø§Ù„Ø³Ù„ÙØ©
        </div>
      </div>

      <!-- Freelancer Settings (Hidden by default) -->
      <div id="freelancer-group" style="display:none;">
        <div style="margin-bottom:16px;">
          <label>ğŸ’¼ ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø±.Ø³)</label>
          <input type="number" id="account-cost" step="0.01" placeholder="30.00" />
          <small style="color:#64748b; font-size:11px; display:block; margin-top:4px;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ÙŠÙØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¹Ù† ÙƒÙ„ ÙŠÙˆÙ… Ø¹Ù…Ù„</small>
        </div>
        
        <div class="formula-box">
          <strong>ğŸ“ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©:</strong><br>
          (Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ + Ø§Ù„Ø¥ÙƒØ±Ø§Ù…ÙŠØ§Øª + Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª + Ø§Ù„Ø¯Ø§Ø¦Ù†) - (Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…Ø­ØµÙ„ + Ø§Ù„Ù…Ø¯ÙŠÙ† + Ø§Ù„ØºØ±Ø§Ù…Ø§Øª) - (Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ã— Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©) - Ø®ØµÙ… Ø§Ù„Ø³Ù„ÙØ©
        </div>
      </div>

      <button class="btn btn-warn" style="width:100%; margin-top:16px;" onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
  </div>

  <!-- Period Selection & Actions -->
  <div class="card" style="margin-bottom: 24px;">
    <div class="grid auto-250">
      <div>
        <label>ğŸ“… Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
        <input type="date" id="payroll-start-date" />
      </div>
      <div>
        <label>ğŸ“… Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
        <input type="date" id="payroll-end-date" />
      </div>
      <div>
        <label>ğŸ‘¥ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
        <select id="group-filter">
          <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</option>
          <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </select>
      </div>
      <div>
        <label>ğŸ“‹ Ø§Ù„Ø­Ø§Ù„Ø©</label>
        <select id="status-filter" onchange="filterByStatus()">
          <option value="draft">Ù…Ø³ÙˆØ¯Ø©</option>
          <option value="approved">Ù…Ø¹ØªÙ…Ø¯</option>
          <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
          <option value="all">Ø§Ù„ÙƒÙ„</option>
        </select>
      </div>
      <div style="display:flex; gap:12px; grid-column: span 2;">
        <button class="btn btn-primary" style="flex:1; display:flex; align-items:center; justify-content:center; gap:8px;" onclick="fetchPayrollData()">ğŸ”„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨</button>
        <button class="btn btn-outline" style="display:flex; align-items:center; gap:8px;" onclick="loadPayrollRecords()">ğŸ“‹ Ø¹Ø±Ø¶</button>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div id="payroll-stats" class="grid auto-180" style="display:none; margin-bottom:24px;">
    <div class="card" style="border-right:4px solid #3b82f6;">
      <div style="font-size:24px; margin-bottom:8px;">ğŸ‘¥</div>
      <div style="color:#64748b; font-size:12px; margin-bottom:6px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</div>
      <div id="stat-drivers" style="font-size:24px; font-weight:700; color:#1e293b;">0</div>
    </div>
    <div class="card" style="border-right:4px solid #8b5cf6;">
      <div style="font-size:24px; margin-bottom:8px;">ğŸ“¦</div>
      <div style="color:#64748b; font-size:12px; margin-bottom:6px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      <div id="stat-orders" style="font-size:24px; font-weight:700; color:#1e293b;">0</div>
    </div>
    <div class="card" style="border-right:4px solid #06b6d4;">
      <div style="font-size:24px; margin-bottom:8px;">ğŸšš</div>
      <div style="color:#64748b; font-size:12px; margin-bottom:6px;">Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„</div>
      <div id="stat-delivery" style="font-size:24px; font-weight:700; color:#1e293b;">0 Ø±.Ø³</div>
    </div>
    <div class="card" style="border-right:4px solid #10b981;">
      <div style="font-size:24px; margin-bottom:8px;">ğŸ’°</div>
      <div style="color:#64748b; font-size:12px; margin-bottom:6px;">Ø§Ù„Ø¥ÙƒØ±Ø§Ù…ÙŠØ§Øª</div>
      <div id="stat-tips" style="font-size:24px; font-weight:700; color:#1e293b;">0 Ø±.Ø³</div>
    </div>
    <div class="card" style="border-right:4px solid #f59e0b;">
      <div style="font-size:24px; margin-bottom:8px;">ğŸ</div>
      <div style="color:#64748b; font-size:12px; margin-bottom:6px;">Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</div>
      <div id="stat-bonuses" style="font-size:24px; font-weight:700; color:#1e293b;">0 Ø±.Ø³</div>
    </div>
    <div class="card" style="border-right:4px solid #ef4444;">
      <div style="font-size:24px; margin-bottom:8px;">âš ï¸</div>
      <div style="color:#64748b; font-size:12px; margin-bottom:6px;">Ø§Ù„ØºØ±Ø§Ù…Ø§Øª</div>
      <div id="stat-penalties" style="font-size:24px; font-weight:700; color:#1e293b;">0 Ø±.Ø³</div>
    </div>
    <div class="card" style="border-right:4px solid #14b8a6;">
      <div style="font-size:24px; margin-bottom:8px;">ğŸ’µ</div>
      <div style="color:#64748b; font-size:12px; margin-bottom:6px;">Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ù…Ø­ØµÙ„</div>
      <div id="stat-cash" style="font-size:24px; font-weight:700; color:#1e293b;">0 Ø±.Ø³</div>
    </div>
    <!-- ğŸ†• Ø¨Ø·Ø§Ù‚Ø© Ø®ØµÙ… Ø§Ù„Ø³Ù„ÙØ© -->
    <div class="card" style="border-right:4px solid #dc2626;">
      <div style="font-size:24px; margin-bottom:8px;">ğŸ’³</div>
      <div style="color:#64748b; font-size:12px; margin-bottom:6px;">Ø®ØµÙ… Ø§Ù„Ø³ÙÙ„Ù</div>
      <div id="stat-advance" style="font-size:24px; font-weight:700; color:#dc2626;">0 Ø±.Ø³</div>
    </div>
    <div class="card" style="border-right:4px solid #6366f1;">
      <div style="font-size:24px; margin-bottom:8px;">ğŸ’</div>
      <div style="color:#64748b; font-size:12px; margin-bottom:6px;">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ØµØ§ÙÙŠ</div>
      <div id="stat-net" style="font-size:24px; font-weight:700; color:#1e293b;">0 Ø±.Ø³</div>
    </div>
  </div>

  <!-- Payroll Table -->
  <div class="card">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; gap:16px; flex-wrap:wrap;">
      <h2 style="font-size:20px; font-weight:600; color:#1e293b;">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h2>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <button id="approve-all-btn" class="btn btn-green" style="display:none;">âœ… Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨</button>
        <button class="btn btn-blue" onclick="exportToExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
      </div>
    </div>
    <div id="payroll-table-content">
      <div style="text-align:center; padding:60px; color:#64748b;">
        <div style="font-size:48px; margin-bottom:16px;">ğŸ’°</div>
        <p>Ù‚Ù… Ø¨Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨"</p>
      </div>
    </div>
  </div>

</div>

<!-- âœ… Updated to version 7 -->
<script src="/assets/js/payroll.js?v=7"></script>