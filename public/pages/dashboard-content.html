<!-- Company Header with Date Filter -->
<div style="background: white; padding: 30px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 30px; border-right: 4px solid #6366f1;">
    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px;">ğŸ¢</div>
            <div>
                <h2 style="color: #1e293b; margin-bottom: 6px; font-size: 24px;" id="company-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
                <p style="color: #64748b; font-size: 14px;">Company ID: <span id="company-id" style="font-weight: 600; color: #6366f1;">--</span></p>
            </div>
        </div>
        
        <!-- Date Picker -->
        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 8px; background: #f8fafc; padding: 12px 16px; border-radius: 12px; border: 1px solid #e2e8f0;">
                <span style="font-size: 14px; color: #64748b;">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</span>
                <input type="date" id="selected-date" onchange="changeDate()" style="border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; color: #1e293b; cursor: pointer;">
            </div>
            
            <button onclick="setToday()" style="padding: 10px 20px; border: 1px solid #e2e8f0; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                <span>ğŸ“†</span>
                <span>Ø§Ù„ÙŠÙˆÙ…</span>
            </button>
            
            <button onclick="refreshData()" style="padding: 10px 20px; border: 1px solid #e2e8f0; background: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                <span>ğŸ”„</span>
                <span>ØªØ­Ø¯ÙŠØ«</span>
            </button>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-right: 4px solid #3b82f6;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ‘¥</div>
        <div style="color: #64748b; font-size: 13px; margin-bottom: 8px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</div>
        <div style="font-size: 28px; font-weight: 700; color: #1e293b;" id="total-drivers">0</div>
    </div>
    
    <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-right: 4px solid #8b5cf6;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ“¦</div>
        <div style="color: #64748b; font-size: 13px; margin-bottom: 8px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
        <div style="font-size: 28px; font-weight: 700; color: #1e293b;" id="total-orders">0</div>
        <div style="font-size: 12px; color: #64748b; margin-top: 6px;">
            Ù…ØªÙˆØ³Ø·: <span id="avg-orders" style="font-weight: 600; color: #8b5cf6;">0</span> Ø·Ù„Ø¨/Ù…Ù†Ø¯ÙˆØ¨
        </div>
    </div>
    
    <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-right: 4px solid #06b6d4;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸšš</div>
        <div style="color: #64748b; font-size: 13px; margin-bottom: 8px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„</div>
        <div style="font-size: 28px; font-weight: 700; color: #1e293b;" id="total-delivery">0 Ø±.Ø³</div>
    </div>
    
    <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-right: 4px solid #10b981;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ’°</div>
        <div style="color: #64748b; font-size: 13px; margin-bottom: 8px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ÙƒØ±Ø§Ù…ÙŠØ§Øª</div>
        <div style="font-size: 28px; font-weight: 700; color: #1e293b;" id="total-tips">0 Ø±.Ø³</div>
    </div>
    
    <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-right: 4px solid #f59e0b;">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ</div>
        <div style="color: #64748b; font-size: 13px; margin-bottom: 8px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</div>
        <div style="font-size: 28px; font-weight: 700; color: #1e293b;" id="total-bonuses">0 Ø±.Ø³</div>
    </div>
    
    <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-right: 4px solid #ef4444;">
        <div style="font-size: 32px; margin-bottom: 12px;">âš ï¸</div>
        <div style="color: #64748b; font-size: 13px; margin-bottom: 8px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºØ±Ø§Ù…Ø§Øª</div>
        <div style="font-size: 28px; font-weight: 700; color: #1e293b;" id="total-penalties">0 Ø±.Ø³</div>
    </div>
</div>

<!-- Performance Table -->
<div style="background: white; padding: 30px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
        <h2 style="font-size: 20px; font-weight: 600; color: #1e293b;">ğŸ“Š Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h2>
        <div style="font-size: 13px; color: #64748b;" id="table-period-info">Ø§Ù„ÙŠÙˆÙ…</div>
    </div>
    <div id="performance-table-content">
        <div style="text-align: center; padding: 40px; color: #64748b;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>
</div>

<style>
table { width: 100%; border-collapse: collapse; font-size: 14px; }
thead { background: #f8fafc; }
th { padding: 14px 12px; text-align: center; font-weight: 600; color: #475569; font-size: 13px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
th:first-child { text-align: right; }
td { padding: 12px 12px; border-bottom: 1px solid #f1f5f9; color: #334155; text-align: center; vertical-align: middle; }
td:first-child { text-align: right; }
tbody tr:hover { background: #fafbfc; transition: all 0.2s; }
tbody tr { cursor: pointer; }

.driver-info { display: flex; align-items: center; gap: 10px; height: 100%; }
.driver-avatar { 
    width: 36px; 
    height: 36px; 
    border-radius: 50%; 
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    color: white; 
    font-weight: 600; 
    font-size: 15px;
    flex-shrink: 0;
}
.driver-details {
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.driver-name {
    font-weight: 600;
    font-size: 14px;
    line-height: 1.3;
    margin-bottom: 2px;
}
.driver-phone {
    font-size: 12px;
    color: #64748b;
    line-height: 1.3;
}

.status-badge { 
    display: inline-flex; 
    align-items: center; 
    gap: 4px; 
    padding: 5px 10px; 
    border-radius: 12px; 
    font-size: 12px; 
    font-weight: 600;
    line-height: 1;
}
.status-online { background: #dcfce7; color: #166534; }
.status-offline { background: #fee2e2; color: #991b1b; }

.metric-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    line-height: 1;
    min-width: 50px;
}
.metric-orders { background: #ede9fe; color: #6d28d9; }
.metric-delivery { background: #cffafe; color: #0e7490; }
.metric-tips { background: #d1fae5; color: #065f46; }
.metric-bonuses { background: #fef3c7; color: #92400e; }
.metric-penalties { background: #fee2e2; color: #991b1b; }
.metric-neutral { background: #f1f5f9; color: #475569; }
</style>

<script>
console.log('ğŸ¬ [Dashboard] Script starting...');

let selectedDate = new Date().toISOString().split('T')[0];

window.formatCurrency = function(amount) {
    return new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount) + ' Ø±.Ø³';
};

window.formatNumber = function(num) {
    return new Intl.NumberFormat('en-US').format(num);
};

window.formatDate = function(dateStr) {
    if (!dateStr) return 'N/A';
    return new Intl.DateTimeFormat('en-GB', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    }).format(new Date(dateStr));
};

window.changeDate = function() {
    const dateInput = document.getElementById('selected-date');
    selectedDate = dateInput.value;
    
    if (selectedDate) {
        document.getElementById('table-period-info').textContent = formatDate(selectedDate);
        loadDriversPerformance();
    }
};

window.setToday = function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('selected-date').value = today;
    selectedDate = today;
    document.getElementById('table-period-info').textContent = 'Ø§Ù„ÙŠÙˆÙ… - ' + formatDate(today);
    loadDriversPerformance();
};

window.loadCompanyInfo = async function() {
    try {
        console.log('ğŸ¢ Loading company...');
        const result = await API.getCompanyInfo();
        
        if (result.success && result.company) {
            document.getElementById('company-name').textContent = result.company.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            document.getElementById('company-id').textContent = result.company.company_id || '--';
        }
    } catch (error) {
        console.error('âŒ Error:', error);
    }
};

window.loadDriversPerformance = async function() {
    try {
        console.log('ğŸ“Š Loading performance for date:', selectedDate);
        
        const finResult = await API.getDriverFinancialsByDate(null, selectedDate, selectedDate);
        const ordersResult = await API.getDriverOrders(null, selectedDate, selectedDate);
        
        console.log('ğŸ“¦ Financial:', finResult);
        console.log('ğŸ“¦ Orders:', ordersResult);

        // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: finResult.financials Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† finResult.drivers
        if (finResult.success && finResult.financials) {
            const driversMap = new Map();
            
            // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: finResult.financials Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† finResult.drivers
            finResult.financials.forEach(d => {
                driversMap.set(d.driver_id, {
                    ...d,
                    total_orders: 0,
                    total_delivery: parseFloat(d.total_delivery) || 0
                });
            });
            
            if (ordersResult.success && ordersResult.data) {
                ordersResult.data.forEach(od => {
                    if (driversMap.has(od.driver_id)) {
                        const driver = driversMap.get(od.driver_id);
                        driver.total_orders = parseInt(od.orders_count) || 0;
                    }
                });
            }
            
            const mergedDrivers = Array.from(driversMap.values());
            mergedDrivers.sort((a, b) => (b.total_orders || 0) - (a.total_orders || 0));
            
            let totalTips = 0, totalBonuses = 0, totalPenalties = 0, totalOrders = 0, totalDelivery = 0, totalDebit = 0, totalCredit = 0;
            mergedDrivers.forEach(d => {
                totalTips += parseFloat(d.total_tips) || 0;
                totalBonuses += parseFloat(d.total_bonuses) || 0;
                totalPenalties += parseFloat(d.total_penalties) || 0;
                totalOrders += parseInt(d.total_orders) || 0;
                totalDelivery += parseFloat(d.total_delivery || d.delivery_price) || 0;
                totalDebit += parseFloat(d.driver_debit) || 0;     
                totalCredit  += parseFloat(d.driver_credit) || 0; 
            });
            
            const avgOrders = mergedDrivers.length > 0 ? Math.round(totalOrders / mergedDrivers.length) : 0;
            
            document.getElementById('total-drivers').textContent = formatNumber(mergedDrivers.length);
            document.getElementById('total-orders').textContent = formatNumber(totalOrders);
            document.getElementById('avg-orders').textContent = formatNumber(avgOrders);
            document.getElementById('total-delivery').textContent = formatCurrency(totalDelivery);
            document.getElementById('total-tips').textContent = formatCurrency(totalTips);
            document.getElementById('total-bonuses').textContent = formatCurrency(totalBonuses);
            document.getElementById('total-penalties').textContent = formatCurrency(totalPenalties);
            
            const html = `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="min-width: 180px;">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                                <th>Driver ID</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                                <th>Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„</th>
                                <th>Credit</th>
                                <th>Debit</th>
                                <th>Ø§Ù„Ø§ÙƒØ±Ø§Ù…ÙŠØ§Øª</th>
                                <th>Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</th>
                                <th>Ø§Ù„ØºØ±Ø§Ù…Ø§Øª</th>
                                <th>Ø§Ù„Ù†Ù‚Ø¯</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${mergedDrivers.map((d, index) => `
                                <tr>
                                    <td>
                                        <div class="driver-info">
                                            <div class="driver-avatar">${d.driver_name  ? d.driver_name .charAt(0) : '?'}</div>
                                            <div class="driver-details">
                                                <div class="driver-name">${d.driver_name  || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                                                <div class="driver-phone">${d.driver_phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td><code style="background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #475569;">${d.driver_id || 'N/A'}</code></td>
                                    <td><span class="status-badge ${d.online ? 'status-online' : 'status-offline'}">${d.online ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'âš« ØºÙŠØ± Ù…ØªØµÙ„'}</span></td>
                                    <td><span class="metric-badge metric-orders">${formatNumber(d.total_orders || 0)}</span></td>
                                    <td><span class="metric-badge metric-delivery">${formatCurrency(d.delivery_price || d.delivery_price || 0)}</span></td>
                                    <td><span class="metric-badge metric-danger">${formatCurrency(parseFloat(d.driver_debit) || 0)}</span></td>
                                    <td><span class="metric-badge metric-success">${formatCurrency(parseFloat(d.driver_credit) || 0)}</span></td>
                                    <td><span class="metric-badge metric-tips">${formatCurrency(d.tips || 0)}</span></td>
                                    <td><span class="metric-badge metric-bonuses">${formatCurrency(d.bonuses || 0)}</span></td>
                                    <td><span class="metric-badge metric-penalties">${formatCurrency(d.penalty || 0)}</span></td>
                                    <td><span class="metric-badge metric-neutral">${formatCurrency(d.cash_collected || 0)}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('performance-table-content').innerHTML = html;
            console.log('âœ… Table rendered with', mergedDrivers.length, 'drivers');
        } else {
            console.log('âš ï¸ No data found');
            document.getElementById('performance-table-content').innerHTML = '<div style="text-align:center;padding:60px;">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
        }
    } catch (error) {
        console.error('âŒ Error:', error);
        document.getElementById('performance-table-content').innerHTML = '<div style="text-align:center;padding:60px;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
    }
};

window.refreshData = function() {
    console.log('ğŸ”„ Refreshing for date:', selectedDate);
    document.getElementById('performance-table-content').innerHTML = '<div style="text-align:center;padding:40px;"><div style="display:inline-block;width:40px;height:40px;border:4px solid #f3f4f6;border-top-color:#6366f1;border-radius:50%;animation:spin 1s linear infinite;"></div></div>';
    setTimeout(() => {
        loadCompanyInfo();
        loadDriversPerformance();
    }, 500);
};

setTimeout(() => {
    console.log('â° Starting auto-load...');
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('selected-date').value = today;
    selectedDate = today;
    document.getElementById('table-period-info').textContent = 'Ø§Ù„ÙŠÙˆÙ… - ' + formatDate(today);
    
    loadCompanyInfo();
    loadDriversPerformance();
}, 1000);
</script>